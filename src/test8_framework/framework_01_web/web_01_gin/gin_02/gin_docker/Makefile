# ç»Ÿä¸€è®¾ç½®
APP_NAME := gin-app
#VERSION  := $(shell date +%Y%m%d%H)
VERSION  ?= $(shell date +%Y%m%d%H)
# ?=è¡¨ç¤ºæ¥å—ä¸€ä¸ªå‚æ•°

# æ„å»ºé•œåƒ
build:
	docker build -t $(APP_NAME):$(VERSION) .
	#make clean-images

# å¯åŠ¨ dev ç¯å¢ƒå®¹å™¨
run-dev: build
	docker stop gin-app-dev || true
	docker rm gin-app-dev || true
	docker run -d \
		--name gin-app-dev \
		-p 18080:18080 \
		-v $(PWD)/config:/app/config \
		-v $(PWD)/logs:/app/logs \
		$(APP_NAME):$(VERSION) ./server -c config/config-dev.yaml


# å¯åŠ¨ test ç¯å¢ƒå®¹å™¨
run-test: build
	docker stop gin-app-test || true
	docker rm gin-app-test || true
	docker run -d \
		--name gin-app-test \
		-p 18090:18090 \
		-v $(PWD)/config:/app/config \
		-v $(PWD)/logs:/app/logs \
		$(APP_NAME):$(VERSION) ./server -c config/config-test.yaml

# å¯åŠ¨ prod ç¯å¢ƒå®¹å™¨
run-prod: build
	docker stop gin-app-prod || true
	docker rm gin-app-prod || true
	docker run -d \
		--name gin-app-prod \
		-p 19090:19090 \
		-v $(PWD)/config:/app/config \
		-v $(PWD)/logs:/app/logs \
		$(APP_NAME):$(VERSION) ./server -c config/config-prod.yaml

# æ¸…ç†æ‰€æœ‰å®¹å™¨
clean:
	docker rm -f gin-app-dev gin-app-test gin-app-prod || true

clean-images:
	@echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€æ–°3ä¸ªï¼‰..."
	@docker images | grep $(APP_NAME) | awk 'NR>3 {print $$3}' | xargs -r docker rmi -f


# makeå¯æ‰§è¡Œå‘½ä»¤å¦‚ä¸‹
# make run-dev VERSION=202507092210     # ä¸€é”®æ„å»º + å¯åŠ¨ dev ç¯å¢ƒ
# make  run-test VERSION=12345    # ä¸€é”®æ„å»º + å¯åŠ¨ test ç¯å¢ƒ
# make run-prod VERSION=12345    # ä¸€é”®æ„å»º + å¯åŠ¨ prod ç¯å¢ƒ
# make clean       # åˆ é™¤æ‰€æœ‰å®¹å™¨
# make clean-images  # åˆ é™¤æ—§é•œåƒ

