<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>分片下载 + 断点续传 + 暂停/继续</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        #progress-bar { height: 100%; width: 0; background: #4caf50; transition: width 0.2s; }
        #log { margin-top: 15px; font-size: 14px; color: #333; white-space: pre-line; }
        button { margin-left: 5px; }
    </style>
</head>
<body>
<h2>分片下载 (断点续传 + 暂停/继续)</h2>
<label>文件名: <input type="text" id="fileName" placeholder="输入文件名，例如 bigvideo.mp4"></label>
<button onclick="startDownload()">开始/继续下载</button>
<button onclick="pauseDownload()">暂停下载</button>

<div id="progress">
    <div id="progress-bar"></div>
</div>
<div id="log"></div>

<script>
    const chunkSize = 5 * 1024 * 1024; // 每片 5MB
    let controller = null;
    let isPaused = false;
    const baseUrl = "http://localhost:8080/download";

    function log(msg) {
        document.getElementById("log").textContent += msg + "\n";
    }

    // 获取文件大小
    async function getFileSize(fileName) {
        const res = await fetch(baseUrl + `/${fileName}`, { headers: { 'Range': 'bytes=0-0' } });
        if (!res.ok && res.status !== 206) throw new Error("无法获取文件大小");
        const contentRange = res.headers.get("Content-Range");
        if (!contentRange) throw new Error("Content-Range 未返回");
        return parseInt(contentRange.split('/')[1]);
    }

    // 获取已下载分片
    function getDownloadedChunks(fileName) {
        const data = localStorage.getItem("download_" + fileName);
        return data ? JSON.parse(data) : [];
    }

    // 保存已下载分片
    function saveDownloadedChunk(fileName, chunkIndex) {
        const downloaded = getDownloadedChunks(fileName);
        if (!downloaded.includes(chunkIndex)) downloaded.push(chunkIndex);
        localStorage.setItem("download_" + fileName, JSON.stringify(downloaded));
    }

    // 暂停下载
    function pauseDownload() {
        if (controller) {
            isPaused = true;
            controller.abort();
            log("⏸ 下载已暂停");
        }
    }

    // 开始或继续下载
    async function startDownload() {
        const fileName = document.getElementById("fileName").value.trim();
        if (!fileName) {
            alert("请输入文件名！");
            return;
        }

        document.getElementById("progress-bar").style.width = "0";
        document.getElementById("log").textContent = "";
        isPaused = false;
        controller = new AbortController();

        let fileSize;
        try {
            fileSize = await getFileSize(fileName);
            log(`文件总大小: ${(fileSize / 1024 / 1024).toFixed(2)} MB`);
        } catch (err) {
            log("获取文件大小失败: " + err);
            return;
        }

        const totalChunks = Math.ceil(fileSize / chunkSize);
        const downloadedChunks = getDownloadedChunks(fileName);
        const chunks = [];

        for (let i = 0; i < totalChunks; i++) {
            if (downloadedChunks.includes(i)) {
                log(`分片 ${i+1}/${totalChunks} 已下载，跳过`);
                chunks[i] = null; // 占位
                continue;
            }

            if (isPaused) break;

            const start = i * chunkSize;
            const end = Math.min(fileSize - 1, (i + 1) * chunkSize - 1);

            try {
                const res = await fetch(baseUrl + `/${fileName}`, {
                    headers: { "Range": `bytes=${start}-${end}` },
                    signal: controller.signal
                });

                if (!res.ok && res.status !== 206) throw new Error(`分片 ${i} 下载失败`);

                const data = await res.arrayBuffer();
                chunks[i] = data;
                saveDownloadedChunk(fileName, i);

                const completedChunks = getDownloadedChunks(fileName).length;
                document.getElementById("progress-bar").style.width = ((completedChunks / totalChunks) * 100) + "%";
                log(`分片 ${i + 1}/${totalChunks} 下载完成: ${data.byteLength} bytes`);

            } catch (err) {
                if (err.name === "AbortError") {
                    log("⏸ 下载已暂停");
                    break;
                } else {
                    log(`分片 ${i + 1} 下载失败: ${err}`);
                    break;
                }
            }
        }

        // 合并所有下载的分片
        if (!isPaused) {
            const blobData = [];
            for (let i = 0; i < totalChunks; i++) {
                if (chunks[i]) blobData.push(chunks[i]);
            }
            if (blobData.length > 0) {
                const blob = new Blob(blobData);
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();

                log("✅ 文件下载完成！");
                localStorage.removeItem("download_" + fileName); // 清除记录
            }
        }
    }
</script>
</body>
</html>
