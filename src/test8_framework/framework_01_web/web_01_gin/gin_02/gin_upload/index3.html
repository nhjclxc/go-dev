<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>分片下载示例 (Range 请求)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        #progress-bar { height: 100%; width: 0; background: #4caf50; transition: width 0.2s; }
        #log { margin-top: 15px; font-size: 14px; color: #333; white-space: pre-line; }
    </style>
</head>
<body>
<h2>分片下载文件 (Range 请求)</h2>
<label>文件名: <input type="text" id="fileName" placeholder="输入文件名，例如 bigvideo.mp4"></label>
<button onclick="downloadFile()">开始下载</button>

<div id="progress">
    <div id="progress-bar"></div>
</div>
<div id="log"></div>

<script>
    const chunkSize = 5 * 1024 * 1024; // 每片 5MB
    const baseUrl = "http://localhost:8080/download";


    function log(msg) {
        document.getElementById("log").textContent += msg + "\n";
    }

    async function getFileSize(fileName) {
        // 发送 Range 请求获取 Content-Range
        const res = await fetch(baseUrl + `/${fileName}`, { headers: { 'Range': 'bytes=0-0' } });
        if (!res.ok && res.status !== 206) {
            throw new Error("无法获取文件大小");
        }
        const contentRange = res.headers.get("Content-Range"); // "bytes 0-0/10485760"
        if (!contentRange) {
            throw new Error("服务器未返回 Content-Range");
        }
        console.log('contentRange', contentRange)
        const total = parseInt(contentRange.split('/')[1]);
        return total;
    }

    async function downloadFile() {
        const fileName = document.getElementById("fileName").value.trim();
        if (!fileName) {
            alert("请输入文件名！");
            return;
        }

        document.getElementById("progress-bar").style.width = "0";
        document.getElementById("log").textContent = "";

        let fileSize;
        try {
            fileSize = await getFileSize(fileName);
            log(`文件总大小: ${(fileSize / 1024 / 1024).toFixed(2)} MB`);
        } catch (err) {
            log("获取文件大小失败: " + err);
            return;
        }

        const totalChunks = Math.ceil(fileSize / chunkSize);
        const chunks = [];

        for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(fileSize - 1, (i + 1) * chunkSize - 1);

            try {
                const res = await fetch(baseUrl + `/${fileName}`, {
                    headers: { "Range": `bytes=${start}-${end}` }
                });
                if (!res.ok && res.status !== 206) {
                    throw new Error(`分片 ${i} 下载失败`);
                }

                const data = await res.arrayBuffer();
                chunks.push(data);

                log(`分片 ${i + 1}/${totalChunks} 下载完成: ${data.byteLength} bytes`);
                document.getElementById("progress-bar").style.width = (((i + 1) / totalChunks) * 100) + "%";

            } catch (err) {
                log(`分片 ${i + 1} 下载失败: ${err}`);
                return;
            }
        }

        // 合并所有分片
        const blob = new Blob(chunks);
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();

        log("✅ 文件下载完成！");
    }
</script>
</body>
</html>
