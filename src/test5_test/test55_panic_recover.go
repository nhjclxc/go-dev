package main

import (
	"errors"
	"fmt"
)

/*
*
panic recover
*/
func main() {

	//test55_01()

	//defer func() {
	//	if r := recover(); r != nil {
	//		fmt.Println("mian å‡ºç°é”™è¯¯ï¼Œr = ", r)
	//	}
	//}()
	//test55_02()
	//fmt.Println("æˆ‘è¢«æ‰§è¡Œäº†å— 4")

	test55_03()

	/*
		ä»£ç è§£æï¼š
		defer å…³é”®å­—
			defer è¯­å¥ç”¨äºå»¶è¿Ÿæ‰§è¡Œä»£ç ï¼Œé€šå¸¸ç”¨äºèµ„æºé‡Šæ”¾ï¼ˆå¦‚å…³é—­æ–‡ä»¶ã€è§£é”äº’æ–¥é”ç­‰ï¼‰ã€‚
			åœ¨ panic å‘ç”Ÿåï¼Œdefer ä»ç„¶ä¼šæ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨ recover æ•è· panicã€‚

		panic å…³é”®å­—
			panic("å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯") è¡¨ç¤ºç¨‹åºè¿›å…¥ä¸å¯æ¢å¤çš„é”™è¯¯çŠ¶æ€ï¼Œå¹¶ç»ˆæ­¢å½“å‰ Goroutine çš„æ­£å¸¸æ‰§è¡Œã€‚
			panic ä¹‹åï¼Œç¨‹åºä¼šå‘ä¸Šå›æº¯ defer è¯­å¥ï¼Œç›´åˆ° recover æ•è·æˆ–ç¨‹åºå´©æºƒã€‚

		recover å…³é”®å­—
			recover() ä»…åœ¨ defer å‡½æ•°ä¸­ä½¿ç”¨ï¼Œä½œç”¨æ˜¯æ•è· panic å¹¶é˜²æ­¢ç¨‹åºå´©æºƒã€‚
			recover() è¿”å› panic ä¼ é€’çš„é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ panicï¼Œåˆ™è¿”å› nilã€‚
	*/
	//å…³é”®ç‚¹æ€»ç»“ï¼š
	//panic ä¼šå¯¼è‡´ç¨‹åºå¼‚å¸¸ä¸­æ­¢ï¼Œé™¤éåœ¨ defer è¯­å¥ä¸­ä½¿ç”¨ recover è¿›è¡Œæ•è·ã€‚
	//recover åªèƒ½åœ¨ defer å†…éƒ¨è°ƒç”¨ï¼Œå¦åˆ™æ— æ³•ç”Ÿæ•ˆã€‚
	//recover å¯ä»¥æ¢å¤ panic è®©ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œé¿å…æ•´ä¸ªè¿›ç¨‹å´©æºƒã€‚
	//è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ panic å¤„ç†ä¸¥é‡é”™è¯¯ï¼Œå¹¶é€šè¿‡ recover è¿›è¡Œé€‚å½“çš„æ¢å¤ï¼Œä»¥ç¡®ä¿ç¨‹åºçš„å¥å£®æ€§ã€‚ ğŸš€
}

// è‡ªå®šä¹‰é”™è¯¯
func test55_03() {
	// åœ¨goä¸­ä½¿ç”¨errors.Newå’Œpanicå†…ç½®å‡½æ•°æ¥å®ç°è‡ªå®šä¹‰é”™è¯¯
	// 1ã€errors.New(é”™è¯¯è¯´æ˜)ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ª error ç±»å‹çš„å€¼ï¼Œé”™è¯¯ä¸€ä¸ªé”™è¯¯
	// 2ã€panicå†…ç½®å‡½æ•°æ¥æ”¶ä¸€ä¸ª interface{} ç±»å‹çš„å€¼ä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œå¯ä»¥æ¥æ”¶ error ç±»å‹çš„å˜é‡è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯ï¼Œå¹¶é€€å‡ºç¨‹åº

	file := "init.config111"

	fmt.Println("test55_03 1")

	//defer func() {
	//	if r := recover(); r != nil {
	//		fmt.Println("è¯»å–é…ç½®æ–‡ä»¶å¼‚å¸¸ï¼ï¼ï¼")
	//	}
	//}()

	fmt.Println("test55_03 2")
	readConfig(file)
	fmt.Println("test55_03 6")

}

func readConfig(file string) bool {
	if "init.config" != file {
		// ä¸æ˜¯æŒ‡å®šçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±æ˜¯è¯´æ˜æ­¤æ–‡ä»¶åä¸æ˜¯é¢„å®šä¹‰çš„é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆæ­¤æ—¶åº”è¯¥æ‰‹åŠ¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œ
		//ä½¿ç”¨ errors.New æ¥è¿›è¡Œä¸€ä¸ª error å¼‚å¸¸åˆ›å»º
		err := errors.New(`not a default config file !!!`)
		// ä½¿ç”¨panicæ¥æŠŠè¿™ä¸ªå¼‚å¸¸å‘å¤–æŠ›å‡º
		fmt.Println("test55_03 3")
		panic(err)
		fmt.Println("test55_03 4")
	}
	fmt.Println("test55_03 5")
	// å‡è®¾è¿›è¡Œè¯»å–æ“ä½œ...
	return true

}

func test55_02() {
	num1 := 10
	num2 := 0

	fmt.Println("æˆ‘è¢«æ‰§è¡Œäº†å— 1")
	// åœ¨æœ‰å¯èƒ½å‘ç”Ÿå¼‚å¸¸çš„è¯­å¥å‰é¢ï¼Œå†™ä¸€ä¸ªdeferçš„å¼‚å¸¸å¤„ç†ï¼Œdeferä¼šåœ¨å‡½æ•°çš„æœ€åè¢«æ‰§è¡Œï¼Œä¸”è¿™ä¸ªé—­åŒ…å‡½æ•°ä¸€å®šä¼šè¢«æ‰§è¡Œ
	// åœ¨é—­åŒ…é‡Œé¢æ•è·recoverçš„å¼‚å¸¸ï¼Œå·²å¯¹å…¶è¿›è¡Œå¤„ç†
	defer func() {
		if r := recover(); r != nil {
			fmt.Println("å‡ºç°é”™è¯¯ï¼Œr = ", r)
		}
	}()

	fmt.Println("æˆ‘è¢«æ‰§è¡Œäº†å— 2")
	num3 := num1 / num2 // panic: runtime error: integer divide by zero
	// åœ¨æœ¬å‡½æ•°å†…ï¼Œå‘ç”Ÿpanicçš„åœ°æ–¹å¾€ä¸‹çš„ä»£ç ä¸ä¼šè¢«æ‰§è¡Œï¼Œæ­¤æ—¶è¿™ä¸ªå‡½æ•°å°±ä¼šæ¨å‡ºäº†ï¼Œ
	// ä½†æ˜¯å¦‚æœå†™äº†deferçš„è¯å°±ä¼šè½¬å…¥deferè¯­å¥æ ‡è¯†çš„é—­åŒ…æ‰§è¡Œï¼Œ
	// å¦‚æœæ”¹é—­åŒ…å†…è°ƒç”¨äº†recover()å‡½æ•°ï¼Œè¯´æ˜è¯¥paincè¢«recover()å‡½æ•°æ•è·äº†ï¼Œè¿™ä¸ªpaincå°±ä¸ä¼šå¾€ä¸Šä¼ é€’äº†
	// å¦‚æœä¸ä½¿ç”¨recover()å‡½æ•°æ¥æ•è·paincé‚£ä¹ˆè¿™ä¸ªpaincå°±ä¼šä¸€å±‚ä¸€å±‚çš„å¾€ä¸Šä¼ é€’ï¼Œç›´è‡³è¢«recover()æ•è·æˆ–è€…ç¨‹åºå¥”æºƒå¯¼è‡´é€€å‡º
	fmt.Println("num3 = %d", num3)
	fmt.Println("æˆ‘è¢«æ‰§è¡Œäº†å— 3")

}

func test55_01() {

	fmt.Println("ç¨‹åºå¼€å§‹")

	// ä½¿ç”¨ defer æœºåˆ¶è°ƒç”¨æ•è· panic çš„å‡½æ•°
	defer func() {
		// ä½¿ç”¨ recover æ¥æ•è·ä¸€ä¸ªå¼‚å¸¸ï¼Œç±»ä¼¼ä¸€ä¸ªcatch
		// å¦‚æœå¼‚å¸¸ä¸ç­‰äºnilï¼Œå³å‘ç”Ÿäº†å¼‚å¸¸
		// é‚£ä¹ˆæ‰§è¡Œç›¸åº”çš„æ•°æ®å¤„ç†
		if r := recover(); r != nil {
			fmt.Println("æ•è·åˆ° panic:", r)
		}
	}()

	fmt.Println("å³å°†å‘ç”Ÿ panic...")
	panic("å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯") // ç±»ä¼¼äºJavaæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸,

	// è¿™è¡Œä»£ç ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸º panic ä¹‹åç¨‹åºä¼šç»ˆæ­¢ï¼Œé™¤éè¢« recover
	fmt.Println("ç¨‹åºç»“æŸ")
}
