package main

import (
	"fmt"
	"sync"
	"time"
)

func main2() {
	// 14.2.2 é€šä¿¡æ“ä½œç¬¦ <-

	/*
		 è¿™ä¸ªæ“ä½œç¬¦ç›´è§‚çš„è¡¨ç¤ºäº†æ•°æ®çš„ä¼ è¾“ï¼šä¿¡æ¯æŒ‰ç…§ç®­å¤´çš„æ–¹å‘æµåŠ¨ã€‚
			æµå‘é€šé“ï¼ˆå‘é€ï¼‰
				ch <- int1 è¡¨ç¤ºï¼šç”¨é€šé“ ch å‘é€å˜é‡ int1ï¼ˆåŒç›®è¿ç®—ç¬¦ï¼Œä¸­ç¼€ = å‘é€ï¼‰
			ä»é€šé“æµå‡ºï¼ˆæ¥æ”¶ï¼‰ï¼Œä¸‰ç§æ–¹å¼ï¼š
				int2 = <- ch è¡¨ç¤ºï¼šå˜é‡ int2 ä»é€šé“ chï¼ˆä¸€å…ƒè¿ç®—çš„å‰ç¼€æ“ä½œç¬¦ï¼Œå‰ç¼€ = æ¥æ”¶ï¼‰æ¥æ”¶æ•°æ®ï¼ˆè·å–æ–°å€¼ï¼‰ï¼›å‡è®¾ int2 å·²ç»å£°æ˜è¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥å†™æˆï¼šint2 := <- chã€‚
		<- ch å¯ä»¥å•ç‹¬è°ƒç”¨è·å–é€šé“çš„ï¼ˆä¸‹ä¸€ä¸ªï¼‰å€¼ï¼Œå½“å‰å€¼ä¼šè¢«ä¸¢å¼ƒï¼Œä½†æ˜¯å¯ä»¥ç”¨æ¥éªŒè¯ï¼Œæ‰€ä»¥ä»¥ä¸‹ä»£ç æ˜¯åˆæ³•çš„ï¼š
			// ä¸€ç›´å‘é€šé“ä¸­è¯»å–æ•°æ®ï¼Œç›´åˆ°æ•°æ®æ˜¯1000çš„æ—¶å€™è¿›è¡ŒæŸç§æ“ä½œ
			if <- ch != 1000{
				...
			}

		åŒä¸€ä¸ªæ“ä½œç¬¦ <- æ—¢ç”¨äºå‘é€ä¹Ÿç”¨äºæ¥æ”¶ï¼Œä½† Go ä¼šæ ¹æ®æ“ä½œå¯¹è±¡å¼„æ˜ç™½è¯¥å¹²ä»€ä¹ˆ ã€‚è™½éå¼ºåˆ¶è¦æ±‚ï¼Œä½†ä¸ºäº†å¯è¯»æ€§é€šé“çš„å‘½åé€šå¸¸ä»¥ ch å¼€å¤´æˆ–è€…åŒ…å« chan ã€‚
		é€šé“çš„å‘é€å’Œæ¥æ”¶éƒ½æ˜¯åŸå­æ“ä½œï¼šå®ƒä»¬æ€»æ˜¯äº’ä¸å¹²æ‰°åœ°å®Œæˆã€‚


		// é€šé“å˜é‡åœ¨ <- å·¦è¾¹ï¼Œè¡¨ç¤ºå‘é€šé“å†…æ”¾æ•°æ®ï¼Œå¦‚ï¼šstrChan <- "Hello"ï¼Œå°† â€œhelloâ€æ”¾å…¥é€šé“
		// é€šé“å˜é‡åœ¨ <- å³è¾¹ï¼Œè¡¨ç¤ºå‘é€šé“å†…å–æ•°æ®ï¼Œå¦‚ï¼šdata = <- strChanï¼Œå°† strChan é€šé“å†…çš„æ•°æ®å–å‡ºå¹¶æ”¾å…¥dataå˜é‡

	*/

	// 1ã€å£°æ˜ä¸€ä¸ªé€šé“
	var strChan chan string = make(chan string)

	// 2ã€å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ¨¡æ‹Ÿæ•°æ®å‘é€è€…ï¼ŒsendData
	go func() {
		//func() {
		strChan <- "Hello"
		strChan <- ","
		strChan <- "Golang"
		strChan <- " "
		strChan <- "World"
	}()

	// 3ã€å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªæ¥æ”¶è€…ï¼ŒreceiveData
	go func() {
		//func() {
		//time.Sleep(1 * time.Second)
		//time.Sleep(5 * time.Second)
		str := ""
		for {
			str = <-strChan
			fmt.Println("receiveData: " + str)

			if str == "," {
				fmt.Println("receiveData goroutine exit")
				return
			}
		}

	}()

	// ä¼‘çœ é˜²æ­¢ç¨‹åºæå‰é€€å‡º
	time.Sleep(3 * time.Second)

	/*
		æˆ‘ä»¬å‘ç°åç¨‹ä¹‹é—´çš„åŒæ­¥éå¸¸é‡è¦ï¼š

		main() ç­‰å¾…äº† 1 ç§’è®©ä¸¤ä¸ªåç¨‹å®Œæˆï¼Œå¦‚æœä¸è¿™æ ·ï¼ŒsendData() å°±æ²¡æœ‰æœºä¼šè¾“å‡ºã€‚
		getData() ä½¿ç”¨äº†æ— é™å¾ªç¯ï¼šå®ƒéšç€ sendData() çš„å‘é€å®Œæˆå’Œ ch å˜ç©ºä¹Ÿç»“æŸäº†ã€‚
		å¦‚æœæˆ‘ä»¬ç§»é™¤ä¸€ä¸ªæˆ–æ‰€æœ‰ go å…³é”®å­—ï¼Œç¨‹åºæ— æ³•è¿è¡Œï¼ŒGo è¿è¡Œæ—¶ä¼šæŠ›å‡º panicï¼š
		---- Error run E:/Go/Goboek/code examples/chapter 14/goroutine2.exe with code Crashed ---- Program exited with code -2147483645: panic: all goroutines are asleep-deadlock!
		ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿè¿è¡Œæ—¶ (runtime) ä¼šæ£€æŸ¥æ‰€æœ‰çš„åç¨‹ï¼ˆåƒæœ¬ä¾‹ä¸­åªæœ‰ä¸€ä¸ªï¼‰æ˜¯å¦åœ¨ç­‰å¾…ç€ä»€ä¹ˆä¸œè¥¿ï¼ˆå¯ä»æŸä¸ªé€šé“è¯»å–æˆ–è€…å†™å…¥æŸä¸ªé€šé“ï¼‰ï¼Œè¿™æ„å‘³ç€ç¨‹åºå°†æ— æ³•ç»§ç»­æ‰§è¡Œã€‚è¿™æ˜¯æ­»é” (deadlock) çš„ä¸€ç§å½¢å¼ï¼Œè€Œè¿è¡Œæ—¶ (runtime) å¯ä»¥ä¸ºæˆ‘ä»¬æ£€æµ‹åˆ°è¿™ç§æƒ…å†µã€‚

		æ³¨æ„ï¼šä¸è¦ä½¿ç”¨æ‰“å°çŠ¶æ€æ¥è¡¨æ˜é€šé“çš„å‘é€å’Œæ¥æ”¶é¡ºåºï¼šç”±äºæ‰“å°çŠ¶æ€å’Œé€šé“å®é™…å‘ç”Ÿè¯»å†™çš„æ—¶é—´å»¶è¿Ÿä¼šå¯¼è‡´å’ŒçœŸå®å‘ç”Ÿçš„é¡ºåºä¸åŒã€‚



		ç»ƒä¹  14.4ï¼šè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆå¦‚æœåœ¨å‡½æ•° getData() çš„ä¸€å¼€å§‹æ’å…¥ time.Sleep(2e9)ï¼Œä¸ä¼šå‡ºç°é”™è¯¯ä½†ä¹Ÿæ²¡æœ‰è¾“å‡ºå‘¢ã€‚
			ç­”ï¼šæ­¤æ—¶ä¸»åç¨‹å·²ç»é€€å‡ºäº†ï¼Œå­åç¨‹æ— æ³•è¿›è¡Œ

		goä¸ºä»€ä¹ˆä¸»åç¨‹é€€å‡ºä¹‹åï¼Œå­åç¨‹æ— æ³•æ­£å¸¸ä½¿ç”¨äº†ï¼Ÿï¼Ÿï¼Ÿ
			è¿™æ˜¯ Go çš„ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„è¡Œä¸ºç‰¹æ€§ï¼šå½“ä¸»åç¨‹ï¼ˆmain() å‡½æ•°ï¼‰é€€å‡ºåï¼Œæ•´ä¸ªç¨‹åºå°±ä¼šç«‹å³ç»ˆæ­¢ï¼Œä¸ç®¡å…¶ä»–å­åç¨‹ï¼ˆgoroutineï¼‰æœ‰æ²¡æœ‰æ‰§è¡Œå®Œã€‚
			ğŸ” åŸå› è§£æï¼šGo ä¸­çš„ main() å‡½æ•°å°±æ˜¯ç¨‹åºçš„å…¥å£ï¼Œmain() æ‰€åœ¨çš„ goroutine æ˜¯â€œä¸» goroutineâ€ã€‚å½“è¿™ä¸ªä¸» goroutine æ‰§è¡Œå®Œæˆï¼ŒGo çš„è¿è¡Œæ—¶ï¼ˆruntimeï¼‰å°±ä¼šé€€å‡ºæ•´ä¸ªç¨‹åºï¼ŒåŒ…æ‹¬æ‰€æœ‰è¿˜åœ¨è¿è¡Œä¸­çš„å­ goroutineã€‚
			è§£å†³æ–¹æ³•ï¼š
				âœ… æ–¹æ³• 1ï¼šä½¿ç”¨ sync.WaitGroup
				âœ… æ–¹æ³• 2ï¼štime.Sleep()ï¼ˆä»…é€‚åˆæµ‹è¯•ï¼‰

	*/

	// 1ã€é¦–å…ˆå®šä¹‰ä¸€ä¸ªç­‰å¾…ç»„
	var wg sync.WaitGroup
	wg.Add(1)

	// å¼€å¯ä¸€ä¸ªå­åç¨‹
	go func() {
		// ä½¿ç”¨defer ç»“åˆwg.Done() æ¥è¡¨ç¤ºè¿™ä¸ªå‡½æ•°ä»‹ç»åä¹Ÿå°±æ˜¯è¿™ä¸ªåç¨‹æ‰§è¡Œå®Œæ¯•çš„ä¿¡å·
		defer wg.Done()
		time.Sleep(2 * time.Second)
		fmt.Println("å­åç¨‹æ‰§è¡Œå®Œæ¯•")
	}()

	// ä¸»åç¨‹ç­‰å¾…æ‰€æœ‰å­åç¨‹çš„å®Œæˆ
	wg.Wait() // ç­‰å¾…æ‰€æœ‰å­ goroutine æ‰§è¡Œå®Œ
	fmt.Println("ä¸»åç¨‹é€€å‡º")

}
