<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>WebSocket èŠå¤©</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #log { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
    input, button { margin: 5px 0; padding: 5px; }
  </style>
</head>
<body>

<h2>WebSocket èŠå¤©æµ‹è¯•</h2>

<div>
  <label>ç”¨æˆ·åï¼š</label>
  <input id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
  <button onclick="register()">æ³¨å†Œ</button>
</div>

<div>
  <label>æ¶ˆæ¯å†…å®¹ï¼š</label><br>
  <input id="message" placeholder="è¾“å…¥æ¶ˆæ¯..." style="width: 300px;" />
</div>

<div>
  <button onclick="sendBroadcast()">å‘é€å¹¿æ’­</button>
  <input id="target" placeholder="ç§èŠå¯¹è±¡ç”¨æˆ·å" />
  <button onclick="sendPrivate()">å‘é€ç§èŠ</button>
  <input id="kick" placeholder="å‰”é™¤å¯¹è±¡ç”¨æˆ·å" style="display: none;" />
  <button onclick="sendKickUser()" style="display: none;">å‰”é™¤ç”¨æˆ·</button>

</div>

<h3>æ¶ˆæ¯æ—¥å¿—</h3>
<div id="log"></div>

<script>
  let ws;

  function log(msg) {
    const logEl = document.getElementById('log');
    logEl.innerHTML += msg + '<br>';
    logEl.scrollTop = logEl.scrollHeight;
  }

  function connect() {
    ws = new WebSocket("ws://localhost:8080/ws");

    ws.onopen = () => log("âœ… è¿æ¥æˆåŠŸ");
    ws.onclose = () => log("âŒ è¿æ¥æ–­å¼€");
    ws.onerror = e => log("âš ï¸ è¿æ¥é”™è¯¯");

    ws.onmessage = e => {
      const data = JSON.parse(e.data);
      // åˆ¤æ–­æ˜¯ä¸æ˜¯ admin ç”¨æˆ·
      if (data.type === "role") {
        // æœåŠ¡å™¨å“åº”çš„æƒé™ä¿¡æ¯
        isAdmin = data.isAdmin;
        if (isAdmin) {
          document.getElementById("kick").style.display = "inline-block";
          document.querySelector("button[onclick='sendKickUser()']").style.display = "inline-block";
        }
        return
      }

      log(`ğŸ“© [${data.type}] ${data.content}`);
    };
  }

  function register() {
    const username = document.getElementById('username').value;
    if (!username) {
      alert("è¯·è¾“å…¥ç”¨æˆ·å");
      return;
    }
    if (!ws || ws.readyState !== WebSocket.OPEN) connect();

    setTimeout(() => {
      ws.send(JSON.stringify({
        type: "register",
        content: username
      }));
    }, 500); // ç­‰å¾…è¿æ¥å»ºç«‹
  }

  function sendBroadcast() {
    const msg = document.getElementById('message').value;
    if (!msg) return;
    ws.send(JSON.stringify({
      type: "broadcast",
      content: msg
    }));
  }

  function sendPrivate() {
    const msg = document.getElementById('message').value;
    const target = document.getElementById('target').value;
    if (!msg || !target) return;
    ws.send(JSON.stringify({
      type: "private",
      target: target,
      content: msg
    }));
  }

  function sendKickUser() {
    console.log("kick")
    const msg = document.getElementById('message').value;
    const kick = document.getElementById('kick').value;
    if (!kick) return;
    console.log("ccc")
    ws.send(JSON.stringify({
      type: "kick",
      target: kick,
      content: msg
    }));
  }

  // è‡ªåŠ¨è¿æ¥
  connect();
</script>

</body>
</html>

<!--

å½“ç„¶å¯ä»¥ï¼ä¸‹é¢æˆ‘ç»™ä½ å†™ä¸€ä¸ªç®€å• HTML å‰ç«¯ï¼Œå¯ä»¥è¿æ¥ä½ çš„ WebSocket æœåŠ¡å¹¶æ”¯æŒï¼š

âœ… æ³¨å†Œç”¨æˆ·å
âœ… å‘é€å¹¿æ’­æ¶ˆæ¯
âœ… å‘é€ç§èŠæ¶ˆæ¯
âœ… æ˜¾ç¤ºæ¥æ”¶åˆ°çš„æ¶ˆæ¯

-->