# redisæ­å»ºå“¨å…µæ¨¡å¼ä»¥åŠgolangè¿æ¥


ä½ æä¾›çš„ Go ä»£ç ä½¿ç”¨äº† **Redis Sentinel æ¨¡å¼**ï¼ˆ`NewFailoverClient` + `MasterName: "mymaster"` + `SentinelAddrs`ï¼‰ï¼Œæ‰€ä»¥ä½ çš„ Redis æœåŠ¡å™¨è¦ **åŒæ—¶é…ç½® Redis ä¸»èŠ‚ç‚¹å’Œ Sentinel**ï¼Œè€Œä¸æ˜¯æ™®é€šå•æœº Redis å°±è¡Œã€‚ä¸‹é¢æˆ‘å¸®ä½ æ¢³ç†å¦‚ä½•é…ç½® `redis.conf` å’Œ `sentinel.conf` æ¥æ»¡è¶³è¿™ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚

---

## 1ï¸âƒ£ ä¸»èŠ‚ç‚¹ Redis é…ç½®ï¼ˆ`redis.conf`ï¼‰

å‡è®¾ä¸»èŠ‚ç‚¹ IP æ˜¯ `127.0.0.1`ï¼Œç«¯å£é»˜è®¤ 6379ï¼š

```conf
# redis.conf ä¸»èŠ‚ç‚¹é…ç½®
bind 127.0.0.1
port 6379
daemonize yes           # åå°è¿è¡Œï¼Œå¯é€‰
protected-mode yes      # é»˜è®¤ yes
requirepass ""          # å¦‚æœå®¢æˆ·ç«¯æ²¡å¯†ç å¯ä»¥ç©º
dir ./                  # æ•°æ®ç›®å½•
dbfilename dump.rdb     # RDB æ–‡ä»¶å
```

> æ³¨æ„ï¼šå¦‚æœä½ åªæœ‰ä¸€ä¸ª Redis èŠ‚ç‚¹ä¸”ä¸éœ€è¦å¯†ç ï¼Œå¯ä»¥ç©ºç€ `requirepass`ã€‚

---

## 2ï¸âƒ£ Sentinel é…ç½®ï¼ˆ`sentinel.conf`ï¼‰

Redis Sentinel ç”¨æ¥ç›‘æ§ä¸»èŠ‚ç‚¹ã€å‘ç°ä¸»ä»ï¼Œå¹¶åœ¨ä¸»èŠ‚ç‚¹å®•æœºæ—¶åšè‡ªåŠ¨åˆ‡æ¢ã€‚ä½ éœ€è¦åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª Sentinel é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ `sentinel-6379.conf`ï¼š

```conf
# sentinel-6379.conf
port 26379
daemonize yes
protected-mode yes

# å“¨å…µç›‘æ§çš„ master åç§° + ä¸»èŠ‚ç‚¹ IP + ä¸»èŠ‚ç‚¹ç«¯å£ + quorum
# quorum: è‡³å°‘å¤šå°‘ä¸ª sentinel åŒæ„ä¸»èŠ‚ç‚¹æŒ‚æ‰æ‰ failover
sentinel monitor mymaster 127.0.0.1 6379 1

# å“¨å…µè®¤è¯ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸»èŠ‚ç‚¹è®¾ç½®äº†å¯†ç ï¼‰
# sentinel auth-pass mymaster <redis-password>

# è‡ªåŠ¨æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 10000
sentinel parallel-syncs mymaster 1
```

> è¿™é‡Œ `MasterName` è¦å’Œ Go å®¢æˆ·ç«¯é‡Œçš„ä¸€è‡´ï¼š`"mymaster"`
> `SentinelAddrs` å¯¹åº”çš„æ˜¯ Sentinel çš„ç«¯å£ï¼ˆè¿™é‡Œæ˜¯ 26379ï¼‰ï¼Œè€Œä¸æ˜¯ Redis ä¸»èŠ‚ç‚¹ 6379

---

## 3ï¸âƒ£ å¯åŠ¨æµç¨‹

1. å¯åŠ¨ä¸»èŠ‚ç‚¹ Redisï¼š

```bash
redis-server /path/to/redis.conf
```

2. å¯åŠ¨ Sentinelï¼š

```bash
redis-sentinel /path/to/sentinel-6379.conf
```

3. Go å®¢æˆ·ç«¯é…ç½®ï¼š

```go
rdb := redis.NewFailoverClient(&redis.FailoverOptions{
    MasterName:    "mymaster",
    SentinelAddrs: []string{"127.0.0.1:26379"}, // æŒ‡å“¨å…µç«¯å£
    Password:      "", // å¦‚æœä¸»èŠ‚ç‚¹æœ‰å¯†ç å°±å¡«
    DB:            0,
})
```

---

### âœ… æ³¨æ„äº‹é¡¹

* **ç«¯å£**ï¼šSentinel é»˜è®¤ 26379ï¼ŒRedis ä¸»èŠ‚ç‚¹é»˜è®¤ 6379ã€‚
* **MasterName**ï¼šå®¢æˆ·ç«¯å’Œ sentinel.conf å¿…é¡»ä¸€è‡´ã€‚
* **å¤šå“¨å…µ**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®è‡³å°‘é…ç½® 3 ä¸ª Sentinel èŠ‚ç‚¹ï¼Œæé«˜å¯ç”¨æ€§ã€‚
* **DB**ï¼šSentinel æ¨¡å¼ä¸‹æ”¯æŒæ•°æ®åº“å·ï¼Œå¯ä»¥ç”¨ 0 æˆ–å…¶ä»–ã€‚

---

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼  **Redis + Sentinel æ¶æ„å›¾**ï¼Œè®©ä½ ç›´è§‚ç†è§£å®¢æˆ·ç«¯å¦‚ä½•é€šè¿‡ `FailoverClient` è‡ªåŠ¨å‘ç°ä¸»èŠ‚ç‚¹ã€‚

ä½ å¸Œæœ›æˆ‘ç”»å—ï¼Ÿ






å¥½çš„ï¼Œæˆ‘ä»¬æŒ‰ä½ æä¾›çš„å®ä¾‹å’Œä»£ç ä»”ç»†åˆ†æï¼š

---

### 1ï¸âƒ£ ä½ çš„éƒ¨ç½²æƒ…å†µ

* **Redis å®ä¾‹**ï¼š

  ```
  node1:6379
  node2:6379
  node3:6379
  ```

  å‡è®¾ä¸»ä»å…³ç³»ä¸ºï¼š

  ```
  node1(master)  -->  node2(slave)
                 -->  node3(slave)
  ```

* **Sentinel**ï¼š

  ```
  node1:26379
  node2:26379
  node3:26379
  ```

  ç›‘æ§ master ä¸º `mymaster`ã€‚

* **è¿æ¥ä»£ç **ï¼š

  ```go
  r.Redis = redis.NewFailoverClient(&redis.FailoverOptions{
      MasterName:    "mymaster",
      SentinelAddrs: config.Common.Redis.Host,
      Password:      config.Common.Redis.Password,
      DB:            config.Common.Redis.DB,
  })
  ```

---

### 2ï¸âƒ£ `redis.NewFailoverClient` çš„è¡Œä¸º

`NewFailoverClient` æ˜¯ **Go-Redis å®˜æ–¹å®¢æˆ·ç«¯æä¾›çš„å“¨å…µé«˜å¯ç”¨è¿æ¥æ–¹å¼**ï¼Œä½œç”¨å¦‚ä¸‹ï¼š

1. **è¿æ¥å“¨å…µåˆ—è¡¨** (`SentinelAddrs`)

    * å®¢æˆ·ç«¯ä¼šå‘è¿™äº›å“¨å…µè¯¢é—®å½“å‰çš„ master èŠ‚ç‚¹åœ°å€ã€‚
2. **è‡ªåŠ¨å‘ç° master**

    * å“¨å…µè¿”å› `(masterIP, masterPort)`ã€‚
    * å®¢æˆ·ç«¯ç›´æ¥è¿æ¥åˆ° master èŠ‚ç‚¹è¿›è¡Œè¯»å†™æ“ä½œã€‚
3. **è‡ªåŠ¨æ•…éšœè½¬ç§»å¤„ç†**

    * å¦‚æœ master æŒ‚äº†ï¼Œå“¨å…µä¼šé€‰ä¸¾æ–°çš„ masterã€‚
    * å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨æ›´æ–° master åœ°å€ï¼Œç»§ç»­è¯»å†™ã€‚

---

### 3ï¸âƒ£ æ•°æ®å†™å…¥çš„ä½ç½®

* **æ‰€æœ‰å†™æ“ä½œ**éƒ½ä¼šå†™åˆ° **å½“å‰ master èŠ‚ç‚¹**ï¼ˆæ¯”å¦‚ `node1:6379`ï¼‰ã€‚
* **slave èŠ‚ç‚¹**ä¼šå¼‚æ­¥å¤åˆ¶ master çš„æ•°æ®ã€‚

  ```
  master(node1)
       |
       | async replication
       v
  slave(node2)
       |
       v
  slave(node3)
  ```
* ä¹Ÿå°±æ˜¯è¯´ï¼š

    * å†™å…¥æ€»æ˜¯å» master
    * æ•°æ®åŒæ­¥åˆ° slave æ˜¯å¼‚æ­¥çš„ï¼Œå­˜åœ¨å¾®å°å»¶è¿Ÿ
    * è¯»å–é»˜è®¤ä¹Ÿæ˜¯ä» masterï¼Œå¦‚æœä½ é…ç½®äº† `ReadOnly` å¯ä»¥ä» slave è¯»å–

---

### 4ï¸âƒ£ ä¸‰ä¸ªå®ä¾‹çš„æ•°æ®æ˜¯å¦åŒæ­¥

* **æ˜¯çš„ï¼Œä½†å¼‚æ­¥**

    * master å†™å…¥ â†’ slave è‡ªåŠ¨å¤åˆ¶
    * å¦‚æœ master å†™å…¥åˆšåˆšå®Œæˆï¼Œä»èŠ‚ç‚¹å¯èƒ½æš‚æ—¶è¿˜æ²¡æœ‰æœ€æ–°æ•°æ®

---

### âœ… æ€»ç»“

| è¿æ¥æ–¹å¼                     | æ•°æ®å†™å…¥ä½ç½®    | æ•°æ®åŒæ­¥æƒ…å†µ                                   |
| ------------------------ | --------- | ---------------------------------------- |
| ç›´æ¥è¿æ¥æŸä¸ªå®ä¾‹ï¼ˆ6379ï¼‰           | è¿æ¥åˆ°çš„èŠ‚ç‚¹    | slave å¦‚æœæœ‰ä¼šå¤åˆ¶ master æ•°æ®ï¼Œä½†å®¢æˆ·ç«¯ä¸ä¼šè‡ªåŠ¨å‘ç° master |
| `NewFailoverClient` + å“¨å…µ | å½“å‰ master | master å†™å…¥ â†’ slave å¼‚æ­¥å¤åˆ¶                   |
| Sentinel (26379)         | ä¸å­˜æ•°æ®      | åªæä¾› master åœ°å€ï¼Œä¸å­˜æ•°æ®                       |

> æ ¸å¿ƒï¼šä½¿ç”¨ `NewFailoverClient` æ—¶ï¼Œæ‰€æœ‰å†™å…¥éƒ½æ˜¯å†™åˆ° master çš„ï¼Œslave è‡ªåŠ¨åŒæ­¥æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸ç”¨å…³å¿ƒå…·ä½“ master èŠ‚ç‚¹æ˜¯å“ªä¸€å°ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç”»ä¸€ä¸ª **å¸¦å“¨å…µçš„ Redis ä¸»ä»å†™å…¥å’ŒåŒæ­¥ç¤ºæ„å›¾**ï¼Œè®©æ•°æ®æµä¸€ç›®äº†ç„¶ã€‚

ä½ å¸Œæœ›æˆ‘ç”»å—ï¼Ÿ




å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ ç”»ä¸€ä¸ª **å¸¦å“¨å…µçš„ Redis ä¸»ä»æ¶æ„ + å†™å…¥åŒæ­¥ç¤ºæ„å›¾**ï¼Œè®©æ•°æ®æµå’Œè®¿é—®é€»è¾‘ç›´è§‚å¯è§ã€‚

---

```
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Sentinel1  â”‚ 26379
                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ monitors
                 â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Sentinel2  â”‚ 26379
                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ monitors
                 â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Sentinel3  â”‚ 26379
                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ monitors
                       â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Master  â”‚ node1:6379
                  â”‚ (write) â”‚
                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                       â”‚ async replication
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Slave  â”‚ node2:6379           â”‚  Slave  â”‚ node3:6379
   â”‚  (read) â”‚                     â”‚  (read) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

### æ•°æ®æµè¯´æ˜

1. **å†™å…¥**ï¼š

    * å®¢æˆ·ç«¯ï¼ˆé€šè¿‡ `NewFailoverClient` è¿æ¥å“¨å…µï¼‰
    * è‡ªåŠ¨æŸ¥è¯¢å½“å‰ master
    * å†™å…¥ç›´æ¥å‘é€åˆ° **master(node1)**

2. **åŒæ­¥**ï¼š

    * master æ•°æ® **å¼‚æ­¥å¤åˆ¶**åˆ° slave(node2) å’Œ slave(node3)
    * slave ä¸Šå¯ä»¥è¯»å–æ•°æ®ï¼ˆå»¶è¿Ÿå¯èƒ½å­˜åœ¨ï¼‰

3. **å“¨å…µä½œç”¨**ï¼š

    * ç›‘æ§ master å’Œ slave çŠ¶æ€
    * å¦‚æœ master æŒ‚æ‰ï¼Œé€‰ä¸¾ä¸€ä¸ªæ–°çš„ master
    * å®¢æˆ·ç«¯è‡ªåŠ¨åˆ‡æ¢åˆ°æ–° master

4. **è¯»å–**ï¼š

    * é»˜è®¤ä» master è¯»å–ï¼ˆä¿è¯å¼ºä¸€è‡´æ€§ï¼‰
    * é…ç½® `ReadOnly` å¯ä» slave è¯»å–ï¼Œå‡è½» master å‹åŠ›

---

ğŸ’¡ æ€»ç»“ï¼š

* **å†™å…¥æ€»æ˜¯ master**
* **slave å¼‚æ­¥åŒæ­¥**
* **å“¨å…µä¸å­˜æ•°æ®ï¼Œåªè´Ÿè´£ç›‘æ§å’Œæä¾› master åœ°å€**

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€ä¸ª **æ›´ç›´è§‚çš„å¸¦ç®­å¤´çš„åŠ¨æ€æ•°æ®æµå›¾**ï¼Œæ ‡å‡ºå†™å…¥å’Œå¤åˆ¶è·¯å¾„ï¼Œä»¥åŠå®¢æˆ·ç«¯è®¿é—®æµç¨‹ã€‚

ä½ å¸Œæœ›æˆ‘ç”»å—ï¼Ÿ
